<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>GTFS Raw Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap');
    body { background: #f8f9fa; 
    font-family: 'Plus Jakarta Sans';}
    pre { background: #fff; border: 1px solid #eee; padding: 12px; font-size: 1em; overflow-x: auto; }
    .label { font-size: 1.1em; font-weight: bold; margin-bottom: 8px; }
    .gtfs-table-wrapper { overflow-x: auto; max-width: 100vw; }
    table.gtfs-table { background: #fff; border: 1px solid #eee; border-collapse: collapse; width: max-content; min-width: 100%; max-width: none; margin-bottom: 1.5em; }
    table.gtfs-table th, table.gtfs-table td { border: 1px solid #eee; padding: 6px 10px; font-size: 0.98em; }
    table.gtfs-table th { background: #f1f3f6; font-weight: bold; }
    table.gtfs-table td.line-num { color: #888; font-size: 0.95em; text-align: right; background: #f8f9fa; }
  </style>
</head>
<body class="container py-4">
  <h2 class="mb-3">GTFS Raw Data Viewer</h2>
  <div class="mb-2 text-muted" style="font-size:0.98em;">Data ini diambil dari GTFS Transjakarta (diperbarui 14 Juli)</div>
  <div class="mb-3 text-muted" style="font-size:0.98em;">Data salah? Hubungi saya di <a href="https://github.com/muhfhri" target="_blank">github.com/muhfhri</a></div>
  <div id="desc" class="mb-3 text-muted"></div>
  <div class="mb-3"><button id="downloadBtn" class="btn btn-primary btn-sm"><iconify-icon icon='mdi:download' inline></iconify-icon> Download Hasil Filter</button></div>
  <div id="raw"></div>
  <script>
    function parseCSV(text) {
      const lines = text.split('\n').filter(line => line.trim() !== '');
      const headers = lines[0].split(',').map(h => h.trim());
      return lines.slice(1).map(line => {
        const values = line.split(',').map(v => v.trim());
        const obj = {};
        headers.forEach((h, i) => obj[h] = values[i]);
        return obj;
      });
    }
    function getQuery() {
      const params = {};
      location.search.replace(/\??([^=&]+)=([^&]*)/g, (_, k, v) => params[k] = decodeURIComponent(v));
      return params;
    }
    async function main() {
      const q = getQuery();
      const file = q.file;
      const idField = Object.keys(q).find(k => k !== 'file');
      const idValue = q[idField];
      document.getElementById('desc').innerHTML = `<span class="label"><iconify-icon icon="mdi:file-document-outline" inline></iconify-icon> File: <b>${file}.txt</b></span><br><span class="label"><iconify-icon icon="mdi:filter" inline></iconify-icon> Filter: <b>${idField} = ${idValue}</b></span>`;
      const resp = await fetch(`gtfs/${file}.txt`);
      const txt = await resp.text();
      const lines = txt.split('\n').filter(line => line.trim() !== '');
      const headers = lines[0];
      const dataLines = lines.slice(1);
      const filterVals = idValue.split(',').map(v => v.trim());
      // Fungsi untuk render tabel GTFS
      function renderTable(headers, filtered, file) {
        if (!filtered.length) return '<div class="text-danger">Tidak ada data ditemukan.</div>';
        let ths = `<th class='line-num'>#</th>` + headers.map(h => `<th>${h}</th>`).join('');
        let trs = filtered.map(f => {
          let tds = f.line.map((v, i) => {
            // Jika file stops, kolom stop_name jadi link ke Google Maps
            if (file === 'stops' && headers[i] === 'stop_name') {
              const latIdx = headers.indexOf('stop_lat');
              const lonIdx = headers.indexOf('stop_lon');
              const lat = f.line[latIdx];
              const lon = f.line[lonIdx];
              if (lat && lon) {
                return `<td><a href='https://www.google.com/maps/search/?api=1&query=${lat},${lon}' target='_blank' rel='noopener'>${v}</a></td>`;
              }
            }
            return `<td>${v}</td>`;
          }).join('');
          return `<tr><td class='line-num'>${f.lineNum}</td>${tds}</tr>`;
        }).join('');
        return `<div class='gtfs-table-wrapper'><table class='gtfs-table'><thead><tr>${ths}</tr></thead><tbody>${trs}</tbody></table></div>`;
      }
      // Ubah parsing dan filter agar hasil berupa array value, bukan string
      let filtered = [];
      dataLines.forEach((line, idx) => {
        const values = line.split(',').map(v => v.trim());
        const row = {};
        headers.split(',').map(h => h.trim()).forEach((h, i) => row[h] = values[i]);
        if (filterVals.includes(row[idField])) {
          filtered.push({line: values, lineNum: idx + 2}); // simpan array value
        }
      });
      let headerArr = headers.split(',').map(h => h.trim());
      let outTable = renderTable(headerArr, filtered, file);
      let extra = '';
      // Jika file calendar, tampilkan juga trips.txt untuk service_id terkait dan route_id jika ada
      if (file === 'calendar' && idField === 'service_id') {
        const tripsResp = await fetch('gtfs/trips.txt');
        const tripsTxt = await tripsResp.text();
        const tripsLines = tripsTxt.split('\n').filter(line => line.trim() !== '');
        const tripsHeaders = tripsLines[0];
        const tripsDataLines = tripsLines.slice(1);
        let tripsFiltered = [];
        const routeIdParam = q.route_id;
        tripsDataLines.forEach((line, idx) => {
          const values = line.split(',').map(v => v.trim());
          const row = {};
          tripsHeaders.split(',').map(h => h.trim()).forEach((h, i) => row[h] = values[i]);
          if (filterVals.includes(row['service_id']) && (!routeIdParam || row['route_id'] === routeIdParam)) {
            tripsFiltered.push({line: values, lineNum: idx + 2});
          }
        });
        if (tripsFiltered.length > 0) {
          let tripsHeaderArr = tripsHeaders.split(',').map(h => h.trim());
          extra = `<div class='label mt-3'><iconify-icon icon=\"mdi:file-document-outline\" inline></iconify-icon> Raw trips.txt (service_id & route_id terkait)</div>` + renderTable(tripsHeaderArr, tripsFiltered, 'trips');
        }
      }
      document.getElementById('raw').innerHTML = outTable + extra;
      // Download button
      document.getElementById('downloadBtn').onclick = function() {
        // Gabungkan hasil tabel ke format txt
        let txtOut = `Line 1: ${headerArr.join(',')}` + '\n' + filtered.map((f, i) => `Line ${f.lineNum}: ${f.line.join(',')}`).join('\n');
        const blob = new Blob([txtOut], {type: 'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${file}-filtered.txt`;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
      };
    }
    main();
  </script>
</body>
</html> 